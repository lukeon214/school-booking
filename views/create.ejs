<h1>Create a Form</h1>

<form id="builderForm" method="POST" action="/create">
  <input required name="title" placeholder="Form Title"><br><br>
  <label>Who can respond?</label><br>
    <select name="private">
      <option value="0" selected>Anyone with the link (Public)</option>
      <option value="1">Only logged-in users</option>
    </select><br><br>

  <div id="fields"></div>
  <button type="button" onclick="addField()">+ Add Field</button><br><br>

  <input type="hidden" name="fieldsJSON" id="fieldsJSON">
  <button type="submit">Save Form</button>
</form>

<script>
let fieldCounter = 0;
const fieldsContainer = document.getElementById('fields');

function addField() {
  const id = `f_${fieldCounter++}`;
  const div = document.createElement('div');
  div.className = 'field';
  div.style = 'border:1px solid #ccc; padding:10px; margin-top:10px';

  div.innerHTML = `
    <label>Label: <input required name="label_${id}"></label><br>
    <label>Type:
      <select name="type_${id}" onchange="toggleChoices(this, '${id}')">
        <option value="text">Text</option>
        <option value="textarea">Textarea</option>
        <option value="number">Number</option>
        <option value="choice">Choice</option>
        <option value="checkbox">Checkboxes</option>
        <option value="dropdown">Dropdown</option>
      </select>
    </label><br>
    <label>Max Responses (optional): <input name="max_${id}" type="number" min="1"></label><br>
    <div id="choices_${id}" style="display:none;">
      <label>Choices (comma separated):<br>
        <input name="choices_${id}">
      </label>
    </div>
    <button type="button" onclick="this.parentElement.remove()">ðŸ—‘ Remove</button>
    <hr>
  `;
  fieldsContainer.appendChild(div);
}

function toggleChoices(select, id) {
  const box = document.getElementById(`choices_${id}`);
  box.style.display = ["choice", "checkbox", "dropdown"].includes(select.value) ? 'block' : 'none';
}

document.getElementById('builderForm').onsubmit = function () {
  const result = [];
  document.querySelectorAll('.field').forEach(div => {
    const label = div.querySelector('[name^=label_]').value.trim();
    const type = div.querySelector('[name^=type_]').value;
    const choiceInput = div.querySelector('[name^=choices_]');
    const limitInput = div.querySelector('[name^=max_]');
    const maxResponses = limitInput.value ? parseInt(limitInput.value) : null;
    const choices = (["choice", "checkbox", "dropdown"].includes(type)) ?
      choiceInput.value.split(',').map(x => x.trim()) : [];

    result.push({ label, type, choices, maxResponses });
  });
  document.getElementById('fieldsJSON').value = JSON.stringify(result);
};
</script>